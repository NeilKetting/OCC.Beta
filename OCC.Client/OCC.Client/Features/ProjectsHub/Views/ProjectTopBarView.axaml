<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:vm="clr-namespace:OCC.Client.Features.ProjectsHub.ViewModels;assembly=OCC.Client"
			 xmlns:conv="clr-namespace:OCC.Client.Converters"
			 mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="60"
			 x:Class="OCC.Client.Features.ProjectsHub.Views.ProjectTopBarView"
			 x:DataType="vm:ProjectTopBarViewModel">

	<UserControl.Resources>
		<conv:StringEqualityConverter x:Key="StringEqualityConverter"/>
		<conv:IntToBoolConverter x:Key="IntToBoolConverter"/>
	</UserControl.Resources>

	<Border Classes="TopHeader" Background="{DynamicResource WeatheredCementGradient}" Padding="10,10,10,25">
		<Grid ColumnDefinitions="Auto, Auto, *" MinHeight="60">

			<!-- LEFT: Project Name and Members -->
			<StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="15" VerticalAlignment="Center" Margin="20,0">
				<!-- Project Name -->
				<!-- Project Name with Dropdown -->
				<Button Classes="Ghost"
						VerticalAlignment="Center"
						Padding="5,2">
					<StackPanel Spacing="2">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<TextBlock Text="{Binding ProjectName, FallbackValue=Engen 1 Stop}" FontSize="18" FontWeight="SemiBold"/>
							<PathIcon Data="{StaticResource IconChevronDown}" Width="10" Height="10" VerticalAlignment="Center" Foreground="{DynamicResource AccentOrange}"/>
						</StackPanel>
						<TextBlock Text="{Binding ProjectAddress}" FontSize="11" Foreground="{DynamicResource TextSecondaryGray}"
								   IsVisible="{Binding ProjectAddress, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
					</StackPanel>

					<Button.Flyout>
						<MenuFlyout Placement="Bottom">
							<MenuItem Header="Edit Project" Command="{Binding EditProjectCommand}">
								<MenuItem.Icon>
									<PathIcon Data="{StaticResource IconEdit}" Width="16" Height="16"/>
								</MenuItem.Icon>
							</MenuItem>
							<MenuItem Header="Project Settings" Command="{Binding ProjectSettingsCommand}">
								<MenuItem.Icon>
									<PathIcon Data="{StaticResource IconSettings}" Width="16" Height="16"/>
								</MenuItem.Icon>
							</MenuItem>
							<Separator/>
							<MenuItem Header="Delete Project" Command="{Binding DeleteProjectCommand}" Foreground="#EF4444" IsVisible="{Binding CanDeleteProject}">
								<MenuItem.Icon>
									<PathIcon Data="{StaticResource IconDelete}" Width="16" Height="16" Foreground="#EF4444"/>
								</MenuItem.Icon>
							</MenuItem>
						</MenuFlyout>
					</Button.Flyout>
				</Button>
			</StackPanel>

			<!-- Site Manager Members Icon -->
			<Button Grid.Column="1" Classes="Ghost" Margin="30,0,0,0">
				<StackPanel Orientation="Horizontal" Spacing="15">
					<Border Width="32" Height="32" CornerRadius="16" Background="{DynamicResource PrimaryTeal}">
						<TextBlock Text="{Binding SiteManagerInitials}" Foreground="White" FontWeight="Bold" FontSize="12"
								   HorizontalAlignment="Center" VerticalAlignment="Center"/>
					</Border>
					<TextBlock Text="{Binding SelectedSiteManager.DisplayName, FallbackValue='Unassigned', TargetNullValue='Unassigned'}" 
                               FontSize="{StaticResource FontSizeMedium}" FontWeight="SemiBold" VerticalAlignment="Center"/>
				</StackPanel>
                
                <Button.Flyout>
                    <Flyout Placement="Bottom">
                        <Grid Width="250">
                            <!-- List of Managers -->
                            <ListBox ItemsSource="{Binding AvailableSiteManagers}" 
                                     SelectedItem="{Binding SelectedSiteManager}" 
                                     SelectionMode="Single"
                                     MaxHeight="300"
                                     IsVisible="{Binding HasSiteManagers}">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="10">
                                            <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center" Margin="5"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                            
                            <!-- Empty State -->
                            <StackPanel Spacing="10" Margin="10" IsVisible="{Binding !HasSiteManagers}">
                                <TextBlock Text="No site managers found." 
                                           Foreground="{DynamicResource TextSecondaryGray}" 
                                           HorizontalAlignment="Center" 
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </Grid>
                    </Flyout>
                </Button.Flyout>
			</Button>

			<!-- CENTER: Tabs -->
			<ScrollViewer Grid.Column="2"
						  HorizontalScrollBarVisibility="Auto"
						  VerticalScrollBarVisibility="Disabled"
						  HorizontalAlignment="Center"
						  Margin="20,0">
				<StackPanel Orientation="Horizontal" Margin="0,0,0,16">

					<Button Classes="MenuTabButton" Command="{Binding SetActiveTabCommand}" CommandParameter="Dashboard" Classes.Active="{Binding ActiveTab, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Dashboard'}">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<PathIcon Data="{StaticResource IconDashboard}" Classes="IconStyle" Width="16" Height="16"/>
							<TextBlock Text="DASHBOARD" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<Button Classes="MenuTabButton" Command="{Binding SetActiveTabCommand}" CommandParameter="List" Classes.Active="{Binding ActiveTab, Converter={StaticResource StringEqualityConverter}, ConverterParameter='List'}">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<PathIcon Data="{StaticResource IconList}" Classes="IconStyle" Width="16" Height="16"/>
							<TextBlock Text="LIST" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<Button Classes="MenuTabButton" Command="{Binding SetActiveTabCommand}" CommandParameter="Gantt" Classes.Active="{Binding ActiveTab, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Gantt'}">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<PathIcon Data="{StaticResource IconGantt}" Classes="IconStyle" Width="16" Height="16"/>
							<TextBlock Text="GANTT" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<Button Classes="MenuTabButton" Command="{Binding SetActiveTabCommand}" CommandParameter="Sheet" Classes.Active="{Binding ActiveTab, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Sheet'}">
						<Grid>
							<StackPanel Orientation="Horizontal" Spacing="8">
								<PathIcon Data="{StaticResource IconSheet}" Classes="IconStyle" Width="16" Height="16"/>
								<TextBlock Text="VARIATION ORDER" VerticalAlignment="Center"/>
								<!-- Open Variations Badge -->
								<Border Background="#EF4444"
										HorizontalAlignment="Right"
										VerticalAlignment="Top"
										Margin="0,-8,-12,0"
										Height="18" MinWidth="18"
										CornerRadius="9"
										Padding="4,0"
										IsVisible="{Binding OpenVariationCount, Converter={StaticResource IntToBoolConverter}}">
									<TextBlock Text="{Binding OpenVariationCount}"
											   Foreground="White"
											   FontSize="10"
											   FontWeight="Bold"
											   HorizontalAlignment="Center"
											   VerticalAlignment="Center"/>
								</Border>
							</StackPanel>
						</Grid>
					</Button>

					<Button Classes="MenuTabButton" Command="{Binding SetActiveTabCommand}" CommandParameter="Calendar" Classes.Active="{Binding ActiveTab, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Calendar'}" IsVisible="{Binding CanAccessCalendar}">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<PathIcon Data="{StaticResource IconCalendar}" Classes="IconStyle" Width="16" Height="16"/>
							<TextBlock Text="CALENDAR" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<Button Classes="MenuTabButton" Command="{Binding SetActiveTabCommand}" CommandParameter="Files" Classes.Active="{Binding ActiveTab, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Files'}">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<PathIcon Data="{StaticResource IconFile}" Classes="IconStyle" Width="16" Height="16"/>
							<TextBlock Text="FILES" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>
				</StackPanel>
			</ScrollViewer>

		</Grid>
	</Border>
</UserControl>



