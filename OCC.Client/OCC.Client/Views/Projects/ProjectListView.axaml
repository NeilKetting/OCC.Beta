<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:OCC.Client.ViewModels.Projects;assembly=OCC.Client"
             xmlns:i="clr-namespace:Avalonia.Xaml.Interactivity;assembly=Avalonia.Xaml.Interactivity"
             xmlns:ia="clr-namespace:Avalonia.Xaml.Interactions.Core;assembly=Avalonia.Xaml.Interactions"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="OCC.Client.Views.Projects.ProjectListView"
             x:DataType="vm:ProjectListViewModel">

    <Interaction.Behaviors>
        <EventTriggerBehavior EventName="Loaded">
            <InvokeCommandAction Command="{Binding LoadProjectsCommand}"/>
        </EventTriggerBehavior>
    </Interaction.Behaviors>

    <Grid Background="White" RowDefinitions="Auto, *">
        <!-- Tool Bar -->
        <Border Grid.Row="0" Classes="TopHeader">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <!-- Tools -->
                    <TextBlock Text="Projects" FontSize="{StaticResource FontSizeXL}" FontWeight="Bold" 
                               Foreground="{DynamicResource TextPrimaryDark}" VerticalAlignment="Center"/>
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="15" VerticalAlignment="Center">
                    <Button Command="{Binding NewProjectCommand}" Classes="Primary">
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <PathIcon Data="{StaticResource IconAddUser}" Width="16" Height="16"/>
                            <TextBlock Text="Create Project" Foreground="{DynamicResource TextPrimaryDark}" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- Search -->
                    <StackPanel Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
                        <TextBox Width="200" Watermark="Search projects..." VerticalContentAlignment="Center" Text="" Background="White" BorderBrush="{DynamicResource BorderGray}" Padding="30,5,10,5"/>
                        <PathIcon Data="{StaticResource IconSearch}" Width="16" Height="16" Foreground="{DynamicResource TextSecondaryGray}"/>
                    </StackPanel>

                    <!-- Filter Projects by Status -->
                    <ComboBox Width="150" Background="White" BorderBrush="{DynamicResource BorderGray}">
                        <ComboBoxItem>Everyone</ComboBoxItem>
                        <ComboBoxItem>Permanent</ComboBoxItem>
                        <ComboBoxItem>Contract</ComboBoxItem>
                    </ComboBox>
                    
                </StackPanel>
            </Grid>
        </Border>
        <!--<Border Grid.Row="0" Padding="20" Classes="Topbar" BorderBrush="{DynamicResource BorderGray}" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <Button Grid.Column="0" Command="{Binding NewProjectCommand}" Classes="Primary" Height="36" Padding="15,0">
                    <TextBlock Text="New Project" FontSize="13" FontWeight="SemiBold"/>
                </Button>

                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="15">
                    <Button Classes="IconButton" ToolTip.Tip="Search">
                        <PathIcon Data="{StaticResource IconSearch}" Classes="IconStyle"/>
                    </Button>
                    <Button Classes="IconButton" ToolTip.Tip="Filter">
                        <PathIcon Data="{StaticResource IconFilter}" Classes="IconStyle"/>
                    </Button>
                     <Button Classes="IconButton" ToolTip.Tip="Sort">
                        <PathIcon Data="{StaticResource IconSettings}" Classes="IconStyle"/>
                    </Button>
                     <Button Classes="IconButton" ToolTip.Tip="Export">
                        <PathIcon Data="{StaticResource IconExternalLink}" Classes="IconStyle"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>-->

        <!-- Projects Grid -->
        <DataGrid Grid.Row="1" ItemsSource="{Binding Projects}"
                  x:Name="Grid"
                  SelectedItem="{Binding SelectedProject}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  GridLinesVisibility="Horizontal"
                  HorizontalGridLinesBrush="{DynamicResource BorderGray}"
                  BorderThickness="0"
                  RowHeight="60"
                  Margin="0">
            
            <!-- Fix: Move DoubleTapped to Row Style for better hit testing -->
            <DataGrid.Styles>
                <Style Selector="DataGridRow">
                    <!-- Note: In Avalonia 11, we might need a different approach if Behaviors inside Styles aren't fully supported,
                         but usually adding a handler in code-behind or using Tapped event is safer.
                         Let's try sticking to Behaviors but attached to the DataGrid itself usually works IF SelectionMode allows it.
                         However, user says "lost functionality", implies it WAS working.
                         The issue might be IsReadOnly="True" or SelectionMode interactions.
                         Alternative: Use Tapped event and check click count.
                    -->
                </Style>
            </DataGrid.Styles>
            
            <Interaction.Behaviors>
                <EventTriggerBehavior EventName="DoubleTapped" SourceObject="{Binding #Grid}">
                     <!-- Explicitly binding SourceObject might help, or we can use the Tapped event with checking click count in code behind if this fails again.
                          But let's try to restore the standard behavior.
                          Actually, DoubleTapped on DataGrid works best if we don't block it.
                          Let's try re-adding it but ensure the CommandParameter is correct.
                          The previous code passed {Binding SelectedProject}.
                     -->
                    <InvokeCommandAction Command="{Binding OpenProjectCommand}" CommandParameter="{Binding SelectedProject}"/>
                </EventTriggerBehavior>
            </Interaction.Behaviors>
            


            <DataGrid.Columns>
                <!-- Name (Fills remaining space) -->
                <DataGridTemplateColumn Header="NAME" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Margin="20,0" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Progress -->
                <DataGridTemplateColumn Header="PROGRESS" Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Grid VerticalAlignment="Center" Margin="20,0" Width="150"> <!-- Fixed width for inner content to ensure bar looks good -->
                                <ProgressBar Value="{Binding Progress}" Maximum="100" Height="20" Background="#F1F5F9" Foreground="#CBD5E1" CornerRadius="2"/>
                                <ProgressBar Value="{Binding Progress}" Maximum="100" Height="20" Background="Transparent" Foreground="#94A3B8" CornerRadius="2" IsVisible="{Binding Progress, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                <TextBlock Text="{Binding Progress, StringFormat='{}{0}%'}" FontSize="11" Foreground="{DynamicResource TextSecondaryGray}" VerticalAlignment="Center" Margin="5,0"/>
                            </Grid>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Project Manager -->
                <DataGridTemplateColumn Header="SITE MANAGER" Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Border Width="30" Height="30" CornerRadius="15" Background="#CBD5E1" HorizontalAlignment="Left" Margin="20,0">
                                <TextBlock Text="{Binding ProjectManagerInitials}" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White" FontSize="11" FontWeight="Bold"/>
                            </Border>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Members -->
               <DataGridTemplateColumn Header="MEMBERS" Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                             <Border Width="30" Height="30" CornerRadius="15" Background="#CBD5E1" HorizontalAlignment="Left" Margin="20,0">
                                <TextBlock Text="{Binding Members[0]}" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White" FontSize="11" FontWeight="Bold"/>
                            </Border>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Status -->
                <DataGridTemplateColumn Header="STATUS" Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Status}" VerticalAlignment="Center" Margin="20,0" Foreground="{DynamicResource TextPrimaryDark}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Latest Finish -->
                 <DataGridTemplateColumn Header="LATEST FINISH" Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding LatestFinishDisplay}" VerticalAlignment="Center" Margin="20,0" Foreground="{DynamicResource TextSecondaryGray}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <!-- Loading -->
        <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center" IsVisible="{Binding IsBusy}">
            <ProgressBar IsIndeterminate="True" Width="200" Foreground="{DynamicResource OCCOrange}"/>
            <TextBlock Text="{Binding BusyText}" HorizontalAlignment="Center" Margin="0,10,0,0" Classes="LabelSmall"/>
        </StackPanel>

        <!-- Empty State -->
         <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center" 
                     IsVisible="{Binding !Projects.Count}">
             <TextBlock Text="No projects found." IsVisible="{Binding !IsBusy}" Classes="LabelSmall"/>
         </StackPanel>
    </Grid>
</UserControl>
