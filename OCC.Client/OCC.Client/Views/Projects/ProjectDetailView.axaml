<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:OCC.Client.ViewModels.Projects"
             xmlns:conv="clr-namespace:OCC.Client.Converters"
             xmlns:proj="clr-namespace:OCC.Client.Views.Projects"
             xmlns:shared="clr-namespace:OCC.Client.Views.Projects.Shared"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="OCC.Client.Views.Projects.ProjectDetailView"
             x:DataType="vm:ProjectDetailViewModel">

    <UserControl.Resources>
        <conv:PriorityToColorConverter x:Key="PriorityToColorConverter"/>
        <conv:IntToIndentationConverter x:Key="IntToIndentationConverter"/>
        <conv:NameToInitialsConverter x:Key="NameToInitialsConverter"/>
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- Generic DataGrid Styles -->
        <Style Selector="DataGridColumnHeader">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryGray}"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="10,0"/>
        </Style>
        <Style Selector="DataGridRow">
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryDark}"/>
            <Setter Property="Padding" Value="5,8"/>
        </Style>
        <Style Selector="DataGridRow:selected /template/ Rectangle#BackgroundRectangle">
            <Setter Property="Fill" Value="{DynamicResource PrimaryTealLight}"/>
        </Style>

        <!-- Site Manager Button Hover Effects -->
        <Style Selector="Button.GhostButton PathIcon">
            <Setter Property="Opacity" Value="0.1"/>
        </Style>
        <Style Selector="Button.GhostButton:pointerover PathIcon">
            <Setter Property="Opacity" Value="1.0"/>
        </Style>
    </UserControl.Styles>

    <UserControl.DataTemplates>
        <!-- Task List View Template -->
        <DataTemplate DataType="{x:Type vm:ProjectTaskListViewModel}" x:DataType="vm:ProjectTaskListViewModel">
            <Grid>
                <!-- Empty State -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="20" IsVisible="{Binding !HasTasks}">
                    <PathIcon Data="{StaticResource IconCheckCircle}" Width="48" Height="48" Foreground="{DynamicResource TextTertiarySlate}"/>
                    <TextBlock Text="No tasks yet" FontSize="18" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
                    <TextBlock Text="Get started by creating your first task for this project." Foreground="{DynamicResource TextSecondaryGray}"/>
                </StackPanel>

                <ScrollViewer IsVisible="{Binding HasTasks}">
                    <StackPanel>
                        <!-- Data Grid -->
                        <DataGrid ItemsSource="{Binding Tasks}"
                                  SelectedItem="{Binding SelectedTask}"
                                  SelectionMode="Single"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  GridLinesVisibility="Horizontal"
                                  HorizontalGridLinesBrush="{DynamicResource BorderGray}"
                                  BorderThickness="0"
                                  Margin="20">
                            <DataGrid.Columns>
                                <!-- Checkbox Column -->
                                <DataGridTemplateColumn Width="Auto">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="DONE" HorizontalAlignment="Left"/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox HorizontalAlignment="Center" IsChecked="{Binding IsComplete}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Task Name -->
                                <DataGridTemplateColumn Header="TASK NAME" Width="*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" Margin="{Binding IndentLevel, Converter={StaticResource IntToIndentationConverter}}">
                                                <!-- Expander Button -->
                                                <Button Classes="IconButton" 
                                                        Command="{Binding $parent[UserControl].((vm:ProjectDetailViewModel)DataContext).ToggleExpandCommand}" 
                                                        CommandParameter="{Binding}"
                                                        Width="20" Height="20" 
                                                        Margin="0,0,5,0"
                                                        IsVisible="{Binding HasChildren}">
                                                     <Panel>
                                                         <PathIcon Data="{StaticResource IconChevronDown}" Width="10" Height="10" 
                                                                   IsVisible="{Binding IsExpanded}"/>
                                                         <PathIcon Data="{StaticResource IconChevronRight}" Width="10" Height="10" 
                                                                   IsVisible="{Binding !IsExpanded}"/>
                                                     </Panel>
                                                </Button>
                                                <!-- Spacer if no children -->
                                                <Panel Width="25" IsVisible="{Binding !HasChildren}"/>
                                                
                                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Site Manager -->
                                <DataGridTemplateColumn Header="SITE MANAGER" Width="Auto">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                                <Button Classes="Ghost" 
                                                        Padding="0" 
                                                        Theme="{StaticResource {x:Type Button}}">
                                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                                        <Panel>
                                                            <Border Width="28" Height="28" CornerRadius="14" 
                                                                    Background="{Binding $parent[UserControl].((vm:ProjectDetailViewModel)DataContext).SiteManagerColor}">
                                                                <TextBlock Text="{Binding $parent[UserControl].((vm:ProjectDetailViewModel)DataContext).SiteManagerInitials}"
                                                                           Foreground="White"
                                                                           FontWeight="Bold"
                                                                           FontSize="11"
                                                                           HorizontalAlignment="Center"
                                                                           VerticalAlignment="Center"/>
                                                            </Border>
                                                        </Panel>
                                                        <PathIcon Data="{StaticResource IconChevronDown}" 
                                                                  Width="10" Height="10" 
                                                                  Foreground="{DynamicResource TextSecondaryGray}"
                                                                  VerticalAlignment="Center"/>
                                                    </StackPanel>

                                                    <Button.Flyout>
                                                        <Flyout Placement="BottomEdgeAlignedLeft">
                                                            <StackPanel Width="220" Spacing="8" Margin="4">
                                                                <TextBlock Text="Assign Site Manager" FontWeight="SemiBold" FontSize="12"/>
                                                                <TextBox Watermark="Search managers..." 
                                                                         Text="{Binding $parent[UserControl].((vm:ProjectDetailViewModel)DataContext).ManagerSearchText, Mode=TwoWay}"/>
                                                                <ListBox ItemsSource="{Binding $parent[UserControl].((vm:ProjectDetailViewModel)DataContext).FilteredSiteManagers}"
                                                                         Background="Transparent">
                                                                    <ListBox.ItemTemplate>
                                                                        <DataTemplate>
                                                                            <Button Command="{Binding $parent[UserControl].((vm:ProjectDetailViewModel)DataContext).AssignSiteManagerCommand}"
                                                                                    CommandParameter="{Binding}"
                                                                                    Background="Transparent"
                                                                                    Padding="4"
                                                                                    HorizontalAlignment="Stretch"
                                                                                    Theme="{StaticResource {x:Type Button}}">
                                                                                <StackPanel Orientation="Horizontal" Spacing="10">
                                                                                    <Border Width="24" Height="24" CornerRadius="12" Background="{DynamicResource PrimaryTeal}">
                                                                                         <TextBlock Text="{Binding DisplayName, Converter={StaticResource NameToInitialsConverter}}" 
                                                                                                    Foreground="White" FontSize="10" FontWeight="Bold"
                                                                                                    HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                                    </Border>
                                                                                    <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center" FontSize="12"/>
                                                                                </StackPanel>
                                                                            </Button>
                                                                        </DataTemplate>
                                                                    </ListBox.ItemTemplate>
                                                                </ListBox>
                                                            </StackPanel>
                                                        </Flyout>
                                                    </Button.Flyout>
                                                </Button>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Assigned To -->
                                <DataGridTemplateColumn Width="200">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="ASSIGNED TO" HorizontalAlignment="Center"/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Width="28" Height="28" CornerRadius="14" Background="{DynamicResource PrimaryTealLight}" HorizontalAlignment="Center">
                                                <TextBlock Text="{Binding AssignedTo}"
                                                           VerticalAlignment="Center"
                                                           HorizontalAlignment="Center"
                                                           Foreground="{DynamicResource PrimaryTeal}"
                                                           FontWeight="Bold"
                                                           FontSize="11"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Priority -->
                                <DataGridTemplateColumn Width="120">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="PRIORITY" HorizontalAlignment="Left"/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" Spacing="5" VerticalAlignment="Center" HorizontalAlignment="Left">
                                                <Ellipse Width="8" Height="8" Fill="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"/>
                                                <TextBlock Text="{Binding Priority}" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Status -->
                                <DataGridTemplateColumn Width="150">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="STATUS" HorizontalAlignment="Left"/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Status}"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       HorizontalAlignment="Left"
                                                       VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Progress -->
                                <DataGridTemplateColumn Width="150">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="PROGRESS" HorizontalAlignment="Left"/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Width="100" Background="Transparent" ToolTip.Tip="{Binding PercentComplete, StringFormat='{}{0}%'}">
                                                <ProgressBar Value="{Binding PercentComplete}"
                                                              Padding="10,0"
                                                              Height="6"
                                                              VerticalAlignment="Center"
                                                              Foreground="{DynamicResource PrimaryTeal}"
                                                              IsHitTestVisible="False"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- Due Date -->
                                <DataGridTemplateColumn Width="150">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="DUE DATE" HorizontalAlignment="Left"/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding FinishDate, StringFormat='{}{0:dd MMM, yyyy}'}"
                                                       HorizontalAlignment="Right"
                                                       VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- New Task Button Container -->
                        <Button Command="{Binding $parent[UserControl].((vm:ProjectDetailViewModel)DataContext).AddNewTaskCommand}" Background="Transparent" Padding="20,12" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
                            <StackPanel Orientation="Horizontal" Spacing="15">
                                <Border Width="20" Height="20" CornerRadius="10" Background="{DynamicResource TextSecondaryGray}">
                                    <PathIcon Data="{StaticResource IconPlus}" Width="10" Height="10" Foreground="White"/>
                                </Border>
                                <TextBlock Text="New Task" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </DataTemplate>

        <!-- Gantt View Template -->
        <DataTemplate DataType="{x:Type vm:ProjectGanttViewModel}" x:DataType="vm:ProjectGanttViewModel">
             <proj:ProjectGanttView/>
        </DataTemplate>
    </UserControl.DataTemplates>

    <Grid Background="White" RowDefinitions="Auto, *">
        <!-- Top Project Navigation Bar -->
        <shared:ProjectTopBarView DataContext="{Binding TopBar}" Grid.Row="0"/>

        <!-- Main Content (List / Gantt Swapping) -->
        <TransitioningContentControl Content="{Binding CurrentView}" Grid.Row="1">
             <TransitioningContentControl.PageTransition>
                  <CrossFade Duration="0:00:00.250" />
             </TransitioningContentControl.PageTransition>
        </TransitioningContentControl>

        <!-- Saving -->
        <StackPanel Grid.RowSpan="2" VerticalAlignment="Center" HorizontalAlignment="Center" IsVisible="{Binding IsBusy}">
            <ProgressBar IsIndeterminate="True" Width="200" Foreground="{DynamicResource OCCOrange}"/>
            <TextBlock Text="{Binding BusyText}" HorizontalAlignment="Center" Margin="0,10,0,0" Classes="LabelSmall"/>
        </StackPanel>
    </Grid>
</UserControl>
