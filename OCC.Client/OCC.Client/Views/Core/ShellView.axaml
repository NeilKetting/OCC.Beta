<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:OCC.Client.ViewModels.Core;assembly=OCC.Client"
             xmlns:vmShared="clr-namespace:OCC.Client.ViewModels.Shared;assembly=OCC.Client"
			 xmlns:viewsShared="using:OCC.Client.Views.Shared"
			 xmlns:core="clr-namespace:OCC.Client.Views.Core"
			 mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
			 x:Class="OCC.Client.Views.Core.ShellView"
			 x:DataType="vm:ShellViewModel">

	<Design.DataContext>
		<vm:ShellViewModel/>
	</Design.DataContext>

	<Grid ColumnDefinitions="Auto, *">
        <!-- Sidebar: Spans full height -->
		<core:SideMenuView Grid.Column="0" DataContext="{Binding SideMenuViewModel}"/>

        <!-- Main Content Area: Content + Footer -->
        <Grid Grid.Column="1" RowDefinitions="*, Auto">
            
            <!-- Page Content -->
            <ContentControl Grid.Row="0" Content="{Binding CurrentPage}" />
            
            <!-- Notification Overlay -->
            <Grid Grid.Row="0" IsVisible="{Binding IsNotificationOpen}" ZIndex="100">
                <!-- Click-away background -->
                <Button HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                        Background="#66000000"
                        Command="{Binding CloseNotificationsCommand}">
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="#66000000"/>
                        </Style>
                        <Style Selector="Button:pressed /template/ ContentPresenter">
                            <Setter Property="Background" Value="#66000000"/>
                        </Style>
                    </Button.Styles>
                </Button>

                <!-- Popup Content -->
                <ContentControl Content="{Binding NotificationVM}"
                                HorizontalAlignment="Left" VerticalAlignment="Top"
                                Margin="0"
                                Width="400" Height="500"/>
            </Grid>

            <!-- Profile Overlay -->
            <Grid Grid.Row="0" IsVisible="{Binding IsProfileOpen}" ZIndex="150" Background="#66000000">
                 <Button HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                        Background="Transparent"
                        Command="{Binding CloseProfileCommand}">
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="Transparent"/>
                        </Style>
                         <Style Selector="Button:pressed /template/ ContentPresenter">
                            <Setter Property="Background" Value="Transparent"/>
                        </Style>
                    </Button.Styles>
                </Button>
                
                <ContentControl Content="{Binding CurrentProfile}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                     <ContentControl.DataTemplates>
                        <DataTemplate DataType="{x:Type vmShared:ProfileViewModel}">
                             <viewsShared:ProfileView/>
                        </DataTemplate>
                     </ContentControl.DataTemplates>
                </ContentControl>
            </Grid>

            <!-- Bottom Status Bar -->
            <Border Grid.Row="1" Background="{DynamicResource SurfaceWhite}" BorderBrush="{DynamicResource BorderGray}" BorderThickness="0,1,0,0" Padding="10,5">
                <Grid>
                    <!-- Left: User Activity -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Spacing="5" Margin="5,0,0,0">
                        <PathIcon Data="{StaticResource IconClock}" Width="14" Height="14" Foreground="{DynamicResource TextSecondaryGray}"/>
                        <TextBlock Text="{Binding UserActivityStatus}" VerticalAlignment="Center" FontSize="12" Foreground="{DynamicResource TextSecondaryGray}"/>
                    </StackPanel>

                    <!-- Right: Online Users -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10">
                        <!-- Bug Report Button -->
                        <Button Background="Transparent" BorderThickness="0" Padding="8,5" Command="{Binding ReportBugCommand}" ToolTip.Tip="Report a Bug" Cursor="Hand" Focusable="False">
                            <StackPanel Orientation="Horizontal" Spacing="5">
                                <PathIcon Data="{StaticResource IconBug}" Width="14" Height="14" Foreground="{DynamicResource AccentOrange}"/>
                                <TextBlock Text="Report Bug" VerticalAlignment="Center" FontSize="12" Foreground="{DynamicResource TextSecondaryGray}"/>
                            </StackPanel>
                        </Button>
                        <Rectangle Width="1" Height="16" Fill="{DynamicResource BorderGray}"/>

                    <Button Background="Transparent" BorderThickness="0" Padding="8,5" Cursor="Hand">
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <PathIcon Data="{StaticResource IconUserOnline}" Width="14" Height="14" Foreground="{DynamicResource PrimaryTeal}"/>
                            <TextBlock Text="Online:" VerticalAlignment="Center" FontSize="12" Foreground="{DynamicResource TextSecondaryGray}"/>
                            <TextBlock Text="{Binding OnlineCount}" VerticalAlignment="Center" FontSize="12" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
                        </StackPanel>
                        
                        <Button.Flyout>
                            <Flyout Placement="TopEdgeAlignedRight" ShowMode="TransientWithDismissOnPointerMoveAway">
                                <StackPanel Spacing="5" MinWidth="150">
                                    <TextBlock Text="Active Users" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}" Margin="0,0,0,5"/>
                                    <ItemsControl ItemsSource="{Binding ConnectedUsers}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Padding="5,2" Background="#F5F5F5" CornerRadius="4" Margin="0,2">
                                                     <Grid ColumnDefinitions="*, Auto">
                                                         <StackPanel Orientation="Horizontal" Spacing="5">
                                                            <Ellipse Width="8" Height="8" Fill="{Binding StatusColor}" VerticalAlignment="Center"/> <!-- Status Dot -->
                                                            <TextBlock Text="{Binding Name}" FontSize="12" VerticalAlignment="Center"/>
                                                         </StackPanel>
                                                         <TextBlock Grid.Column="1" Text="{Binding TimeOnline}" FontSize="11" Foreground="{DynamicResource TextSecondaryGray}" VerticalAlignment="Center" Margin="10,0,0,0"/>
                                                     </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    <TextBlock Text="No users connected" IsVisible="{Binding !OnlineCount}" FontStyle="Italic" Foreground="{DynamicResource TextSecondaryGray}"/>
                                </StackPanel>
                            </Flyout>
                        </Button.Flyout>
                    </Button>
                </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- Toast Notifications Overlay (Bottom Right) -->
        <ItemsControl Grid.Column="1" VerticalAlignment="Bottom" HorizontalAlignment="Right" 
                      Margin="0,0,20,50" ItemsSource="{Binding Toasts}" ZIndex="200">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Spacing="10"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Border Background="White" CornerRadius="8" Padding="15,10" 
                            BoxShadow="0 4 15 0 #20000000" Width="300"
                            Opacity="{Binding Opacity}"
                            BorderThickness="4,0,0,0"
                            Classes.Info="{Binding IsInfo}"
                            Classes.Success="{Binding IsSuccess}"
                            Classes.Warning="{Binding IsWarning}"
                            Classes.Error="{Binding IsError}">
                        <Border.Styles>
                            <Style Selector="Border.Info"> <Setter Property="BorderBrush" Value="#3B82F6"/> </Style>
                            <Style Selector="Border.Success"> <Setter Property="BorderBrush" Value="#10B981"/> </Style>
                            <Style Selector="Border.Warning"> <Setter Property="BorderBrush" Value="#F59E0B"/> </Style>
                            <Style Selector="Border.Error"> <Setter Property="BorderBrush" Value="#EF4444"/> </Style>
                        </Border.Styles>
                        <Grid ColumnDefinitions="Auto, *">
                            <PathIcon Grid.Column="0" Width="20" Height="20" Margin="0,0,10,0" VerticalAlignment="Center">
                                <PathIcon.Styles>
                                    <!-- Simple manual mapping since I don't want to create a converter for this quick task -->
                                    <!-- I'll use a converter for the Data if possible or just default to Info -->
                                    <Style Selector="PathIcon"> <Setter Property="Data" Value="{StaticResource IconInfo}"/> <Setter Property="Foreground" Value="#3B82F6"/> </Style>
                                </PathIcon.Styles>
                            </PathIcon>
                            <StackPanel Grid.Column="1" Spacing="2">
                                <TextBlock Text="{Binding Title}" FontWeight="Bold" FontSize="13"/>
                                <TextBlock Text="{Binding Message}" FontSize="12" Foreground="{DynamicResource TextSecondaryGray}" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
	</Grid>
</UserControl>
